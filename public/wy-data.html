<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>

<dom-module id="wy-data">  
  <script>    
    class Data extends Polymer.Element {
      static get is() { return "wy-data" }                        

      async fetchReports(weeknumber) {                                        
        const snapshot = await firebase.database().ref(`/reports/${weeknumber}`).once('value');          
        const reports = snapshot.val();
        
        return reports;        
      }
      
      async fetchReport(userid, weeknumber) {                                        
        const snapshot = await firebase.database().ref(`/reports/${weeknumber}/${userid}/report`).once('value');          
        const reports = snapshot.val();
        
        return reports;        
      }
      
      async saveReport(userid, weeknumber, data) {
        const timestamp = firebase.database.ServerValue.TIMESTAMP;
        
        // Get the reviewer information from settings
        const reviewer = (await this.fetchSettings(userid)).reviewer;
        
        const report = { data, reviewer, timestamp }
        
        firebase.database().ref(`/reports/${weeknumber}/${userid}/report`).set(report);
      }
      
      async fetchSettings(userid) {
        const snapshot = await firebase.database().ref(`/settings/${userid}`).once('value');
        const settings = snapshot.val();
        
        return settings;
      }
      
      async saveSettings(userid, data) {
        firebase.database().ref(`/settings/${userid}`).set(data);
      }

      async saveComment(userid, weeknumber, comment) {
        firebase.database().ref(`/reports/${weeknumber}/${userid}/comment`).set(comment);
      }
      
      
    }
    
    
    
    window.addEventListener('WebComponentsReady', function() {      
      customElements.define('wy-data', Data);
    });
  </script>
</dom-module>